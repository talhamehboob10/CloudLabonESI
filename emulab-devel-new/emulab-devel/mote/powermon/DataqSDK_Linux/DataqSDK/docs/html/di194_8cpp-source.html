<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DataqSDK: di194.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>di194.cpp</h1><div class="fragment"><pre>00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">                          di194.cpp  -  Linux driver for DI-194 series</span>
00003 <span class="comment">                                        acquisition device manufactured by</span>
00004 <span class="comment">                                        DATAQ Instruments, Inc.</span>
00005 <span class="comment">                             -------------------</span>
00006 <span class="comment">    begin                : Mon Jun 7 2004</span>
00007 <span class="comment">    author               : Ioan S. Popescu</span>
00008 <span class="comment"></span>
00009 <span class="comment">Copyright (C) 2004 DATAQ Instruments, Inc. &lt;develop@dataq.com&gt;</span>
00010 <span class="comment"></span>
00011 <span class="comment">This program is free software; you can redistribute it and/or </span>
00012 <span class="comment">modify it under the terms of the GNU General Public License </span>
00013 <span class="comment">as published by the Free Software Foundation; either </span>
00014 <span class="comment">version 2 of the License, or (at your option) any later </span>
00015 <span class="comment">version.</span>
00016 <span class="comment"></span>
00017 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00018 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00019 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00020 <span class="comment">GNU General Public License for more details.</span>
00021 <span class="comment"></span>
00022 <span class="comment">You should have received a copy of the GNU General Public License</span>
00023 <span class="comment">along with this program; if not, write to the Free Software</span>
00024 <span class="comment">Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
00025 <span class="comment"> ***************************************************************************/</span>
00026 
00027 <span class="preprocessor">#include "di194.h"</span>
00028 
<a name="l00042"></a><a class="code" href="classdi194__dsdk.html#a0">00042</a> <a class="code" href="classdi194__dsdk.html#a0">di194_dsdk::di194_dsdk</a>():<a class="code" href="classdsdk.html">dsdk</a>()
00043 {
00044   <a class="code" href="classdi194__dsdk.html#p2">chan_order</a>[0] = 0;
00045   m_ADChannelCount = 1;
00046   <span class="comment">// create new lists</span>
00047   m_ADChannelList = <span class="keyword">new</span> <span class="keywordtype">int</span>[m_ADChannelCount];
00048   m_ADMethodList = <span class="keyword">new</span> <span class="keywordtype">int</span>[m_ADChannelCount];
00049   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00050   {
00051     m_ADChannelList[i] = i;
00052     m_ADMethodList[i] = IOS_AVERAGE;
00053     <a class="code" href="classdi194__dsdk.html#p2">chan_order</a>[i] = i * DI194_CHAN_SIZE;
00054   }
00055 
00056   <a class="code" href="classdi194__dsdk.html#p0">digital_chan</a> = <span class="keyword">false</span>;
00057 
00058   m_MaxBurstRate = 240.00;
00059   <span class="comment">// set to default sample rate based on channels activated</span>
00060   <a class="code" href="group__GetProperties.html#ga24">SampleRate</a>(m_SampleRate);
00061 }
00062 
<a name="l00067"></a><a class="code" href="classdi194__dsdk.html#a1">00067</a> <a class="code" href="classdi194__dsdk.html#a1">di194_dsdk::~di194_dsdk</a>()
00068 {
00069   <a class="code" href="group__Methods.html#ga17">DeviceDisconnect</a>();
00070 
00071   <span class="keywordflow">if</span>(m_ADChannelList != 0)
00072   {
00073     <span class="keyword">delete</span> [] m_ADChannelList;
00074     m_ADChannelList = 0;
00075   }
00076   <span class="keywordflow">if</span>(m_ADDiffList != 0)
00077   {
00078     <span class="keyword">delete</span> [] m_ADDiffList;
00079     m_ADDiffList = 0;
00080   }
00081   <span class="keywordflow">if</span>(m_ADGainList != 0)
00082   {
00083     <span class="keyword">delete</span> [] m_ADGainList;
00084     m_ADGainList = 0;
00085   }
00086   <span class="keywordflow">if</span>(m_ADMethodList != 0)
00087   {
00088     <span class="keyword">delete</span> [] m_ADMethodList;
00089     m_ADMethodList = 0;
00090   }
00091   <span class="keywordflow">if</span>(m_device_file != 0)
00092   {
00093     <span class="keyword">delete</span> [] m_device_file;
00094     m_device_file = 0;
00095   }
00096 }
00097 
00098 <span class="comment">// Get "Properties"</span>
00099 
<a name="l00103"></a><a class="code" href="group__GetProperties.html#ga20">00103</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="group__GetProperties.html#ga20">di194_dsdk::ADChannelCount</a>()
00104 {
00105   <span class="keywordflow">return</span> m_ADChannelCount;
00106 }
00107 
<a name="l00112"></a><a class="code" href="group__GetProperties.html#ga21">00112</a> <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> <a class="code" href="group__GetProperties.html#ga21">di194_dsdk::AvailableData</a>()
00113 {
00114   <span class="comment">// no data if not acquiring</span>
00115   <span class="keywordflow">if</span>(!m_acquiring_data)
00116     <span class="keywordflow">return</span> 0;
00117 
00118   <span class="keywordflow">return</span> <a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a7">bytes_in_receive</a>()/DI194_CHAN_SIZE; 
00119 }
00120 
<a name="l00124"></a><a class="code" href="group__GetProperties.html#ga22">00124</a> <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> <a class="code" href="group__GetProperties.html#ga22">di194_dsdk::EventPoint</a>()
00125 {
00126   <span class="keywordflow">return</span> m_EventPoint;
00127 }
00128 
<a name="l00142"></a><a class="code" href="group__GetProperties.html#ga23">00142</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="group__GetProperties.html#ga23">di194_dsdk::InfoSerial</a>()
00143 {
00144   <span class="comment">// can't get serial number while acquiring data</span>
00145   <span class="keywordflow">if</span>(m_acquiring_data)
00146   {
00147     m_last_error = EBUSY;
00148     <span class="keywordflow">return</span> 0;
00149   }
00150   <span class="comment">// must be connected</span>
00151   <span class="keywordflow">if</span>(!<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>())
00152   {
00153     m_last_error = ENOLINK;
00154     <span class="keywordflow">return</span> 0;
00155   }
00156 
00157   <span class="keywordtype">char</span> *sn = <span class="keyword">new</span> <span class="keywordtype">char</span>[DI194_SN_LENGTH];
00158   <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga0">Ncmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, sn))
00159     m_last_error = my_errno;
00160 
00161   <span class="keywordflow">return</span> sn;
00162 }
00163 
<a name="l00167"></a><a class="code" href="group__GetProperties.html#ga24">00167</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="group__GetProperties.html#ga24">di194_dsdk::SampleRate</a>()
00168 {
00169   <span class="keywordflow">return</span> m_SampleRate;
00170 }
00171 
00172 <span class="comment">// Set "Properties"</span>
00173 
<a name="l00202"></a><a class="code" href="group__SetProperties.html#ga15">00202</a> <span class="keywordtype">void</span> <a class="code" href="group__GetProperties.html#ga20">di194_dsdk::ADChannelCount</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> ChannelCount)
00203 {
00204   <span class="comment">// can't set while acquiring data</span>
00205   <span class="keywordflow">if</span>(m_acquiring_data)
00206   {
00207     m_last_error = EBUSY;
00208     <span class="keywordflow">return</span>;
00209   }
00210   <span class="comment">// must be connected</span>
00211   <span class="keywordflow">if</span>(!<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>())
00212   {
00213     m_last_error = ENOLINK;
00214     <span class="keywordflow">return</span>;
00215   }
00216   <span class="comment">// bounds check</span>
00217   <span class="keywordflow">if</span>(ChannelCount &gt; DI194_CHANNELS || ChannelCount &lt; 1)
00218   {
00219     m_last_error = <a class="code" href="group__ADDITIONAL__CODES.html#ga0">EBOUNDS</a>;
00220     <span class="keywordflow">return</span>;
00221   }
00222   <span class="comment">// pointer check</span>
00223   <span class="keywordflow">if</span>(m_ADChannelList != 0)
00224   {
00225     <span class="keyword">delete</span> [] m_ADChannelList;
00226     m_ADChannelList = 0;
00227   }
00228   <span class="comment">// pointer check</span>
00229   <span class="keywordflow">if</span>(m_ADMethodList != 0)
00230   {
00231     <span class="keyword">delete</span> [] m_ADMethodList;
00232     m_ADMethodList = 0;
00233   }
00234 
00235   m_ADChannelCount = ChannelCount;
00236   m_ADChannelList = <span class="keyword">new</span> <span class="keywordtype">int</span>[m_ADChannelCount];
00237   m_ADMethodList = <span class="keyword">new</span> <span class="keywordtype">int</span>[m_ADChannelCount];
00238   <span class="comment">// initialize with default values</span>
00239   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00240   {
00241     m_ADChannelList[i] = i;
00242     m_ADMethodList[i] = IOS_AVERAGE;
00243   }
00244   
00245   <span class="comment">// check if all channels requested</span>
00246   <span class="comment">// if so, change last channel to digital</span>
00247   <span class="keywordflow">if</span>(m_ADChannelCount == DI194_CHANNELS)
00248   {
00249     m_ADChannelList[DI194_CHANNELS-1] = -1;
00250     <span class="comment">// 'all channels' includes digital ports</span>
00251     <a class="code" href="classdi194__dsdk.html#p0">digital_chan</a> = <span class="keyword">true</span>;
00252     <span class="comment">// last point makes more sense for digital</span>
00253     m_ADMethodList[DI194_CHANNELS-1] = IOS_LAST_POINT;
00254     <span class="comment">// setup channel order (used in conversion)</span>
00255     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;DI194_CHANNELS-1; i++)
00256       <a class="code" href="classdi194__dsdk.html#p2">chan_order</a>[i] = i;
00257   }
00258   <span class="keywordflow">else</span> <span class="comment">// no digital</span>
00259   {
00260     <a class="code" href="classdi194__dsdk.html#p0">digital_chan</a> = <span class="keyword">false</span>;
00261     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00262       <a class="code" href="classdi194__dsdk.html#p2">chan_order</a>[i] = i;
00263   }
00264 
00265   <span class="comment">// set sample rate according to new channels</span>
00266   <a class="code" href="group__GetProperties.html#ga24">SampleRate</a>(m_SampleRate);
00267 
00268   <span class="comment">/* set channels to scan for acquisition</span>
00269 <span class="comment">  1   -   analog channel 1</span>
00270 <span class="comment">  2   -   analog channel 2</span>
00271 <span class="comment">  4   -   analog channel 3</span>
00272 <span class="comment">  8   -   analog channel 4</span>
00273 <span class="comment"></span>
00274 <span class="comment">  add together to get any combination of channels</span>
00275 <span class="comment">      OR</span>
00276 <span class="comment">  each bit is a channel: 4 (left) to 1 (right) using above scheme</span>
00277 <span class="comment">  channel 1, binary: 0001     (decimal: 1)</span>
00278 <span class="comment">  channel 2,3 binary: 0110    (decimal: 6) */</span>
00279   u_int8_t chan = 0;
00280   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00281   {
00282     <span class="keywordflow">if</span>(m_ADChannelList[i] &gt; -1)
00283       chan |= (0x01 &lt;&lt; m_ADChannelList[i]);
00284   }
00285   <span class="comment">// enable digital channel input</span>
00286   <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p0">digital_chan</a>)
00287   {
00288     <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga2">Dcmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, 1))
00289     {
00290       m_last_error = my_errno;
00291       <span class="keywordflow">return</span>;
00292     }
00293   }
00294   <span class="keywordflow">else</span>  <span class="comment">// disable digital channel input</span>
00295   {
00296     <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga2">Dcmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, 0))
00297     {
00298       m_last_error = my_errno;
00299       <span class="keywordflow">return</span>;
00300     }
00301   }
00302   <span class="comment">// enable analog channels</span>
00303   <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga1">Ccmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, chan))
00304   {
00305     m_last_error = my_errno;
00306     <span class="keywordflow">return</span>;
00307   }
00308 }
00309 
<a name="l00314"></a><a class="code" href="group__SetProperties.html#ga16">00314</a> <span class="keywordtype">void</span> <a class="code" href="group__GetProperties.html#ga22">di194_dsdk::EventPoint</a>(<span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> EventPnt)
00315 {
00316   <span class="keywordflow">if</span>(EventPnt &lt; 0)
00317     m_EventPoint = 0;
00318   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(EventPnt &gt; 32767)
00319     m_EventPoint = 32767;
00320   <span class="keywordflow">else</span>
00321     m_EventPoint = EventPnt;
00322   
00323   <span class="keywordflow">return</span>;
00324 }
00325 
<a name="l00337"></a><a class="code" href="group__SetProperties.html#ga17">00337</a> <span class="keywordtype">void</span> <a class="code" href="group__GetProperties.html#ga24">di194_dsdk::SampleRate</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> SampleRt)
00338 {
00339   <span class="comment">// can't set while acquiring data</span>
00340   <span class="keywordflow">if</span>(m_acquiring_data)
00341   {
00342     m_last_error = EBUSY;
00343     <span class="keywordflow">return</span>;
00344   }
00345 
00346   <span class="keywordtype">double</span> maxsr = 0;
00347   <span class="keywordtype">double</span> minsr = 0;
00348   
00349   <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p0">digital_chan</a>)  <span class="comment">// don't include digital channel in count</span>
00350   {
00351     <span class="keywordflow">if</span>(m_ADChannelCount == 1)
00352     {
00353       maxsr = DI194_MAXBURSTRATE; <span class="comment">// don't divide by 0</span>
00354       minsr = DI194_MINBURSTRATE; <span class="comment">// don't multiply by 0</span>
00355     }
00356     <span class="keywordflow">else</span>
00357     { <span class="comment">// subtract out the digital channel</span>
00358       maxsr = DI194_MAXBURSTRATE / (m_ADChannelCount - 1);
00359       minsr = DI194_MINBURSTRATE * (m_ADChannelCount - 1);
00360     }
00361   }
00362   <span class="keywordflow">else</span>  <span class="comment">// no digital channel to worry about</span>
00363   {
00364     maxsr = DI194_MAXBURSTRATE / m_ADChannelCount;
00365     minsr = DI194_MINBURSTRATE * m_ADChannelCount;
00366   }
00367   <span class="comment">// user wants minimum, set to minimum</span>
00368   <span class="keywordflow">if</span>(SampleRt &lt;= minsr)
00369     m_SampleRate = minsr;
00370   <span class="comment">// user wants maximum, set to maximum</span>
00371   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SampleRt &gt;= maxsr)
00372     m_SampleRate = maxsr;
00373   <span class="keywordflow">else</span>  <span class="comment">// inbetween, user is within bounds</span>
00374     m_SampleRate = SampleRt;
00375 }
00376 
00377 <span class="comment">// "Methods"</span>
00378 
<a name="l00403"></a><a class="code" href="group__Methods.html#ga14">00403</a> <span class="keywordtype">void</span> <a class="code" href="group__Methods.html#ga14">di194_dsdk::ADChannelList</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> *<span class="keyword">const</span> ChannelList)
00404 {
00405   <span class="comment">// can't set while acquiring data</span>
00406   <span class="keywordflow">if</span>(m_acquiring_data)
00407   {
00408     m_last_error = EBUSY;
00409     <span class="keywordflow">return</span>;
00410   }
00411   <span class="comment">// must be connected</span>
00412   <span class="keywordflow">if</span>(!<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>())
00413   {
00414     m_last_error = ENOLINK;
00415     <span class="keywordflow">return</span>;
00416   }
00417   <span class="comment">// pointer check</span>
00418   <span class="keywordflow">if</span>(ChannelList == 0)
00419   {
00420     m_last_error = EINVAL;
00421     <span class="keywordflow">return</span>;
00422   }
00423   <span class="comment">// used to check if multiple digital channels are specified,</span>
00424   <span class="comment">// there shouldn't be</span>
00425   <span class="keywordtype">bool</span> check_digital = <span class="keyword">false</span>;
00426   <span class="comment">// bounds check</span>
00427   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00428   {
00429     <span class="keywordflow">if</span>(ChannelList[i] &gt;= DI194_CHANNELS-1 || ChannelList[i] &lt; -1)
00430     {
00431       m_last_error = <a class="code" href="group__ADDITIONAL__CODES.html#ga0">EBOUNDS</a>;
00432       <span class="keywordflow">return</span>;
00433     }
00434     <span class="comment">// make sure only one digital channel is specified</span>
00435     <span class="keywordflow">if</span>(ChannelList[i] == -1 &amp;&amp; !check_digital)
00436       check_digital = <span class="keyword">true</span>;
00437     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ChannelList[i] == -1)
00438     {
00439       m_last_error = <a class="code" href="group__ADDITIONAL__CODES.html#ga0">EBOUNDS</a>;
00440       <span class="keywordflow">return</span>;
00441     }
00442   }
00443 
00444   <span class="comment">// must have at least one analog channel enabled</span>
00445   <span class="keywordflow">if</span>(m_ADChannelCount == 1 &amp;&amp; check_digital)
00446   {
00447     m_last_error = <a class="code" href="group__ADDITIONAL__CODES.html#ga0">EBOUNDS</a>;
00448     <span class="keywordflow">return</span>;
00449   }
00450 
00451   <span class="comment">// temporary, used for setting up channel order</span>
00452   <span class="keywordtype">int</span> temp_chan[DI194_CHANNELS] = {0};
00453 
00454   <span class="comment">// set digital channel setting to what was determined in bounds check</span>
00455   <a class="code" href="classdi194__dsdk.html#p0">digital_chan</a> = check_digital;
00456 
00457   <span class="comment">// copy the channel list</span>
00458   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00459   {
00460     m_ADChannelList[i] = ChannelList[i];
00461     temp_chan[i] = ChannelList[i];
00462   }
00463 
00464   <span class="comment">// sort channel list, it's only 5 channels max,</span>
00465   <span class="comment">// bubble sort will work</span>
00466   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=1; i&lt;m_ADChannelCount; i++)
00467   {
00468     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;m_ADChannelCount-i; j++)
00469     {
00470       <span class="keywordflow">if</span>(temp_chan[j] &gt; temp_chan[j+1]) <span class="comment">// need to swap?</span>
00471       {
00472         temp_chan[j] = temp_chan[j] ^ temp_chan[j+1];
00473         temp_chan[j+1] = temp_chan[j] ^ temp_chan[j+1];
00474         temp_chan[j] = temp_chan[j] ^ temp_chan[j+1];
00475       }
00476     }
00477   }
00478 
00479   <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p0">digital_chan</a>)
00480   {
00481     <span class="comment">// setup channel order</span>
00482     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=1; i&lt;m_ADChannelCount; i++)
00483       <a class="code" href="classdi194__dsdk.html#p2">chan_order</a>[temp_chan[i]] = (i-1) * DI194_CHAN_SIZE;
00484   }
00485   <span class="keywordflow">else</span>
00486   {
00487     <span class="comment">// setup channel order</span>
00488     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00489         <a class="code" href="classdi194__dsdk.html#p2">chan_order</a>[temp_chan[i]] = i * DI194_CHAN_SIZE;
00490   }
00491 
00492   <span class="comment">/* set channels to scan for acquisition</span>
00493 <span class="comment">  1   -   analog channel 1</span>
00494 <span class="comment">  2   -   analog channel 2</span>
00495 <span class="comment">  4   -   analog channel 3</span>
00496 <span class="comment">  8   -   analog channel 4</span>
00497 <span class="comment"></span>
00498 <span class="comment">  add together to get any combination of channels</span>
00499 <span class="comment">      OR</span>
00500 <span class="comment">  each bit is a channel: 4 (left) to 1 (right) using above scheme</span>
00501 <span class="comment">  channel 1, binary: 0001     (decimal: 1)</span>
00502 <span class="comment">  channel 2,3 binary: 0110    (decimal: 6) */</span>
00503   u_int8_t chan = 0;
00504   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00505   {
00506     <span class="keywordflow">if</span>(m_ADChannelList[i] != -1)
00507       chan |= (0x01 &lt;&lt; m_ADChannelList[i]);
00508   }
00509   <span class="comment">// enable digital channel input</span>
00510   <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p0">digital_chan</a>)
00511   {
00512     <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga2">Dcmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, 1))
00513     {
00514       m_last_error = my_errno;
00515       <span class="keywordflow">return</span>;
00516     }
00517   }
00518   <span class="keywordflow">else</span>  <span class="comment">// disable digital channel input</span>
00519   {
00520     <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga2">Dcmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, 0))
00521     {
00522       m_last_error = my_errno;
00523       <span class="keywordflow">return</span>;
00524     }
00525   }
00526   <span class="comment">// enable analog channels</span>
00527   <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga1">Ccmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, chan))
00528   {
00529     m_last_error = my_errno;
00530     <span class="keywordflow">return</span>;
00531   }
00532 }
00533 
<a name="l00548"></a><a class="code" href="group__Methods.html#ga15">00548</a> <span class="keywordtype">void</span> <a class="code" href="group__Methods.html#ga15">di194_dsdk::ADMethodList</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> *<span class="keyword">const</span> MethodList)
00549 {
00550   <span class="comment">// can't set while acquiring data</span>
00551   <span class="keywordflow">if</span>(m_acquiring_data)
00552   {
00553     m_last_error = EBUSY;
00554     <span class="keywordflow">return</span>;
00555   }
00556   <span class="comment">// pointer check</span>
00557   <span class="keywordflow">if</span>(MethodList == 0)
00558   {
00559     m_last_error = EINVAL;
00560     <span class="keywordflow">return</span>;
00561   }
00562 
00563   <span class="comment">// bounds check</span>
00564   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00565   {
00566     <span class="keywordflow">if</span>(MethodList[i] &gt; IOS_GREATEST || MethodList[i] &lt; IOS_SMALLEST)
00567     {
00568       m_last_error = <a class="code" href="group__ADDITIONAL__CODES.html#ga0">EBOUNDS</a>;
00569       <span class="keywordflow">return</span>;
00570     }
00571   }
00572 
00573   <span class="comment">// copy the list</span>
00574   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;m_ADChannelCount; i++)
00575     m_ADMethodList[i] = MethodList[i];
00576 }
00577 
<a name="l00593"></a><a class="code" href="group__Methods.html#ga16">00593</a> <span class="keywordtype">void</span> <a class="code" href="group__Methods.html#ga16">di194_dsdk::DeviceConnect</a>()
00594 {
00595   <span class="comment">// can't set while acquiring data</span>
00596   <span class="keywordflow">if</span>(m_acquiring_data)
00597   {
00598     m_last_error = EBUSY;
00599     <span class="keywordflow">return</span>;
00600   }
00601   <span class="comment">// device file hasn't been set</span>
00602   <span class="keywordflow">if</span>(m_device_file == 0)
00603   {
00604     m_last_error = ENODEV;
00605     <span class="keywordflow">return</span>;
00606   }
00607   <span class="comment">// already connected</span>
00608   <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>())
00609   {
00610     m_last_error = EALREADY;
00611     <span class="keywordflow">return</span>;
00612   }
00613 
00614   <span class="comment">// open the serial port</span>
00615   <span class="comment">// setup the serial port</span>
00616   my_errno = <a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a2">connect</a>(m_device_file, 1);
00617   <span class="keywordflow">if</span>(my_errno != 0)
00618   {
00619     m_last_error = my_errno;
00620     <a class="code" href="group__Methods.html#ga17">DeviceDisconnect</a>();
00621     <span class="keywordflow">return</span>;
00622   }
00623 
00624   <span class="comment">// make sure device is stopped</span>
00625   m_acquiring_data = <span class="keyword">true</span>;
00626   <a class="code" href="group__Methods.html#ga20">Stop</a>();
00627 }
00628 
<a name="l00640"></a><a class="code" href="group__Methods.html#ga17">00640</a> <span class="keywordtype">void</span> <a class="code" href="group__Methods.html#ga17">di194_dsdk::DeviceDisconnect</a>()
00641 {
00642   <span class="comment">// check if user forgot to stop acquiring</span>
00643   <span class="keywordflow">if</span>(m_acquiring_data)
00644     <span class="comment">// stop acquiring first</span>
00645     <a class="code" href="group__Methods.html#ga20">Stop</a>();
00646   m_acquiring_data = <span class="keyword">false</span>;
00647   <span class="comment">// check if already disconnected</span>
00648   <span class="keywordflow">if</span>(!<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>())
00649     <span class="keywordflow">return</span>;
00650   <span class="comment">// restore original serial port settings and</span>
00651   <span class="comment">// try to close the serial port</span>
00652   m_last_error = <a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a3">disconnect</a>();
00653 }
00654 
<a name="l00685"></a><a class="code" href="group__Methods.html#ga18">00685</a> <span class="keywordtype">void</span> <a class="code" href="group__Methods.html#ga18">di194_dsdk::GetDataEx</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *iArray, <span class="keyword">const</span> <span class="keywordtype">int</span> Count)
00686 {
00687   <span class="comment">// bounds check</span>
00688   <span class="keywordflow">if</span>(Count &gt; 32767 || Count &lt; 1)
00689   {
00690     m_last_error = <a class="code" href="group__ADDITIONAL__CODES.html#ga0">EBOUNDS</a>;
00691     <span class="keywordflow">return</span>;
00692   }
00693   <span class="comment">// pointer check</span>
00694   <span class="keywordflow">if</span>(iArray == 0)
00695   {
00696     m_last_error = EINVAL;
00697     <span class="keywordflow">return</span>;
00698   }
00699   <span class="comment">// must be acquiring</span>
00700   <span class="keywordflow">if</span>(!m_acquiring_data)
00701   {
00702     m_last_error = ENODATA;
00703     <span class="keywordflow">return</span>;
00704   }
00705 
00706   u_int8_t di_data[DI194_CHAN_SIZE*(DI194_CHANNELS-1)] = {0};
00707   <span class="keywordtype">int</span> mCount = 0;
00708   <span class="comment">// number of oversamples per real sample</span>
00709   <span class="keywordtype">int</span> srinterval = static_cast&lt;int&gt;(m_MaxBurstRate/ (<a class="code" href="classdi194__dsdk.html#p0">digital_chan</a>
00710                                           ? m_ADChannelCount-1
00711                                           : m_ADChannelCount)
00712                                            + 1 - m_SampleRate);
00713   <span class="keywordflow">if</span>(srinterval &lt;= 0)
00714     srinterval = 1;
00715   <span class="comment">// temporarily holds original data to perform calculation</span>
00716   <span class="keywordtype">short</span> <span class="keywordtype">int</span> temp[DI194_CHANNELS] = {0};
00717   <span class="comment">// in case user asks for less data points than in a normal scan</span>
00718   <span class="keywordtype">int</span> small_sample = m_ADChannelCount &lt; Count ? m_ADChannelCount : Count;
00719   <span class="comment">// holds intermittent values for IOS_AVERAGE</span>
00720   int64_t ios_avg[DI194_CHANNELS] = {0};
00721   <span class="keywordtype">bool</span> first_time = <span class="keyword">true</span>;
00722   u_int16_t amount = 0;
00723   <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p0">digital_chan</a>) <span class="comment">// digital channel is embedded</span>
00724   {
00725     amount = DI194_CHAN_SIZE*(m_ADChannelCount-1);
00726   }
00727   <span class="keywordflow">else</span>  <span class="comment">// no digital channel</span>
00728   {
00729     amount = DI194_CHAN_SIZE*m_ADChannelCount;
00730   }
00731 
00732   <span class="comment">// loop until enough data points have been gathered,</span>
00733   <span class="comment">// as far as blocks of enabled channels go</span>
00734   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> c=0, d=0, e=0; c&lt;Count; c += small_sample, d=0)
00735   {
00736     first_time = <span class="keyword">true</span>;
00737     <span class="keywordflow">for</span>(e=0; e&lt;small_sample; e++)
00738       ios_avg[e] = 0;
00739 
00740     <span class="comment">// loop until the right number of samples have been gathered for</span>
00741     <span class="comment">// the specific sample rate</span>
00742     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> timer=0; timer&lt;srinterval; timer++)
00743     {
00744       <span class="comment">// get data</span>
00745       <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a5">di_read</a>(&amp;di_data[0], amount, static_cast&lt;u_int8_t&gt;(amount)))
00746       {
00747         m_last_error = my_errno; <span class="comment">// error occurred</span>
00748         <span class="keywordflow">return</span>;
00749       }
00750       <span class="comment">// copy original values</span>
00751       <span class="keywordflow">for</span>(e=0; e&lt;small_sample; e++)
00752         temp[e] = iArray[c+e];
00753       <span class="comment">// convert new data to counts and store in array</span>
00754       <span class="keywordflow">for</span>(e=0; e&lt;small_sample; e++)
00755         iArray[c + e] = static_cast&lt;short int&gt;(<a class="code" href="classdi194__dsdk.html#b0">convert</a>(&amp;di_data[0], e));
00756       <span class="comment">// increment number of oversamples per scan</span>
00757       d++;
00758       <span class="comment">// don't perform any calculations the first time through</span>
00759       <span class="keywordflow">if</span>(first_time)
00760       {
00761         first_time = <span class="keyword">false</span>;
00762         <span class="keywordflow">for</span>(e=0; e&lt;small_sample; e++)
00763           ios_avg[e] += iArray[c+e];
00764         <span class="keywordflow">continue</span>;
00765       }
00766       <span class="comment">// apply method to 'original' and 'new' data values</span>
00767       <span class="keywordflow">for</span>(e=0; e&lt;small_sample; e++)
00768       {
00769         <span class="keywordflow">switch</span>(m_ADMethodList[e])
00770         {
00771           <span class="keywordflow">case</span> IOS_RMS:  <span class="comment">// not implemented</span>
00772           <span class="keywordflow">case</span> IOS_FREQ: <span class="comment">// not implemented</span>
00773           <span class="keywordflow">case</span> IOS_LAST_POINT:  <span class="comment">// last point</span>
00774             <span class="comment">// this happens by default, nothing to do</span>
00775             <span class="keywordflow">break</span>;
00776           <span class="keywordflow">case</span> IOS_AVERAGE: <span class="comment">// average of points</span>
00777             ios_avg[e] += iArray[c+e];     <span class="comment">// adds up values, after conversion above</span>
00778             iArray[c+e] = ios_avg[e] / d;  <span class="comment">// stores new average</span>
00779             <span class="keywordflow">break</span>;
00780           <span class="keywordflow">case</span> IOS_MIN: <span class="comment">// minimum of points</span>
00781             <span class="keywordflow">if</span>(temp[e] &lt; iArray[c+e])
00782               iArray[c+e] = temp[e];
00783             <span class="keywordflow">break</span>;
00784           <span class="keywordflow">case</span> IOS_MAX: <span class="comment">// maximum of points</span>
00785             <span class="keywordflow">if</span>(temp[e] &gt; iArray[c+e])
00786               iArray[c+e] = temp[e];
00787             <span class="keywordflow">break</span>;
00788         }
00789       }
00790     }
00791   }
00792 
00793   <span class="comment">// any amount left that wasn't an even divisor of scanned blocks?</span>
00794   <span class="comment">// just use the next scanned packet</span>
00795   mCount = Count % m_ADChannelCount;
00796   <span class="keywordflow">if</span>(mCount != 0) <span class="comment">// true if not done</span>
00797   {
00798     <span class="comment">// grab some more data</span>
00799     <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a5">di_read</a>(&amp;di_data[0], amount, static_cast&lt;u_int8_t&gt;(amount)))
00800     {
00801       m_last_error = my_errno; <span class="comment">// error occurred</span>
00802       <span class="keywordflow">return</span>;
00803     }
00804     <span class="comment">// and store part of it</span>
00805     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> e=0; e&lt;mCount; e++)
00806       iArray[Count - mCount + e] = static_cast&lt;short int&gt;(<a class="code" href="classdi194__dsdk.html#b0">convert</a>(&amp;di_data[0], e));
00807   }
00808 }
00809 
<a name="l00822"></a><a class="code" href="group__Methods.html#ga19">00822</a> <span class="keywordtype">void</span> <a class="code" href="group__Methods.html#ga19">di194_dsdk::Start</a>()
00823 {
00824   <span class="comment">// don't send command if already acquiring, this is an error because</span>
00825   <span class="comment">// there is data in the buffer</span>
00826   <span class="keywordflow">if</span>(m_acquiring_data)
00827   {
00828     m_last_error = EALREADY;
00829     <span class="keywordflow">return</span>;
00830   }
00831   <span class="keywordflow">if</span>(!<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>()) <span class="comment">// don't bother if not connected</span>
00832   {
00833     m_last_error = ENOLINK;
00834     <span class="keywordflow">return</span>;
00835   }
00836 
00837   <span class="comment">// send command</span>
00838   <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga3">Scmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>, 1))
00839   {
00840     m_last_error = my_errno;
00841     <span class="keywordflow">return</span>;
00842   }
00843 
00844   m_acquiring_data = <span class="keyword">true</span>;
00845 }
00846 
<a name="l00858"></a><a class="code" href="group__Methods.html#ga20">00858</a> <span class="keywordtype">void</span> <a class="code" href="group__Methods.html#ga20">di194_dsdk::Stop</a>()
00859 {
00860   <span class="comment">// can't set while not acquiring data,</span>
00861   <span class="comment">// not really an error</span>
00862   <span class="keywordflow">if</span>(!m_acquiring_data)
00863     <span class="keywordflow">return</span>;
00864   <span class="comment">// must be connected</span>
00865   <span class="keywordflow">if</span>(!<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>())
00866   {
00867     m_last_error = ENOLINK;
00868     <span class="keywordflow">return</span>;
00869   }
00870 
00871   <span class="comment">// send command</span>
00872   <span class="keywordflow">if</span>(!<a class="code" href="group__DI194__COMMANDS.html#ga3">Scmd</a>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>))
00873   {
00874     m_last_error = my_errno;
00875     <span class="keywordflow">return</span>;
00876   }
00877 
00878   m_acquiring_data = <span class="keyword">false</span>;
00879 }
00880 
00881 <span class="comment">// "Event Occur" Methods</span>
00882 
<a name="l00894"></a><a class="code" href="group__EventOccurMethods.html#ga3">00894</a> <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="group__EventOccurMethods.html#ga3">di194_dsdk::OverRun</a>()
00895 {
00896   <span class="comment">// must be connected</span>
00897   <span class="keywordflow">if</span>(!<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a4">is_comm_open</a>())
00898   {
00899     m_last_error = ENOLINK;
00900     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00901   }
00902 
00903   <span class="comment">// doesn't set an error because this function represents an error</span>
00904   <span class="keywordflow">if</span>(<a class="code" href="classdi194__dsdk.html#p1">m_connection</a>.<a class="code" href="classdi__serial__io.html#a7">bytes_in_receive</a>() &gt;= DI_SERIAL_BUFFER_SIZE)
00905     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00906 
00907   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00908 }
00909 
<a name="l00916"></a><a class="code" href="classdi194__dsdk.html#b0">00916</a> <span class="keyword">const</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="classdi194__dsdk.html#b0">di194_dsdk::convert</a>(<span class="keyword">const</span> u_int8_t *<span class="keyword">const</span> di_data,
00917                                     <span class="keyword">const</span> u_int8_t num_chan)
00918 {
00919   <span class="keywordtype">short</span> <span class="keywordtype">int</span> temp = 0;
00920   <span class="comment">// extract and convert to counts</span>
00921   <span class="comment">// find out whether it's an analog or digital channel</span>
00922   <span class="keywordflow">if</span>(m_ADChannelList[num_chan] != -1) <span class="comment">// analog channel</span>
00923   {
00924     temp = static_cast&lt;short int&gt;(di_data[<a class="code" href="classdi194__dsdk.html#p2">chan_order</a>[m_ADChannelList[num_chan]]]
00925                    &amp; 0xE0) &gt;&gt; 5;
00926     temp |= (static_cast&lt;short int&gt;(di_data[chan_order[m_ADChannelList[num_chan]]+1]
00927                    &amp; 0xFE) &lt;&lt; 2);
00928     temp &lt;&lt;= 6; <span class="comment">// left justify the number</span>
00929     temp ^= 0x8000;
00930   }
00931   <span class="keywordflow">else</span> <span class="comment">// digital bits</span>
00932     temp = (di_data[0] &amp; 0x0E) &gt;&gt; 1;
00933 
00934   <span class="keywordflow">return</span> temp;
00935 }
00936 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Aug 2 09:44:49 2004 for DataqSDK by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
